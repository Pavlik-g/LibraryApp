<!-- version 1.0 release -->

<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title></title>

    <link rel="stylesheet" href="sources/style/main.css">
    <link rel="stylesheet" href="sources/style/account.css">
    <link rel="stylesheet" href="sources/style/message.css">
    <link rel="stylesheet" href="sources/style/button.css">

    <script src="sources/js/nesql.js"></script>
    <script src="sources/js/add.js"></script>
    <script src="sources/js/message.js"></script>
</head>

<body>
    <nav class="navigation">
        <a class="but" id="home" href="index.html"></a> <!-- Button home -->
        <a class="but" id="back" onclick="history.back()"></a> <!-- Button back -->
    </nav>
    <main>
        <div class="box">
            <div class="head">
                <div class="but_nav">
                    <a class="but" id="edit"></a>
                </div>
                <table class="head_information"></table>
            </div>
            <div class="information">
                <div class="but_nav" id="btn"></div>
            </div>
        </div>
    </main>

    <script>
        let GET = parseURL(); // Сюда сохраняем данные из ссылки на страницу
        let isBook;

        switch(GET['type']) {
            case 'book':  isBook = 2; break; // 2 - Страница книга
            case 'group': isBook = 1; break; // 1 - Страница группы книг
            case 'user':  isBook = 0; break; // 0 - Страница ученика
        }

        let users = new Table('users'); // Создаем таблицу для работы с учениками
        let books = new Table('books'); // Создаем таблицу для работы с книгами

        let user, userBooks;

        if (!isBook) {
            userBooks = books.equal(books.translate(), 'userid', GET['id']); // Сохраняем в переменную значения книг, принадлежащих ученику
            user      = users.equal(users.translate(), 'id', GET['id'])[0]; // Сохраняем в переменную значения ученика по ID
        } else {
            if (isBook == 2) {
                userBooks = books.equal(books.translate(), 'id', GET['id'])[0]; // Сохраняем в переменную значения книги по ID
            } else {
                userBooks = books.equal(books.translate(), 'groupid', GET['id']); // Сохраняем в переменную значения книги по ID
            }
            user = users.equal(users.translate(), 'id', userBooks['userid'])[0]; // Сохраняем в переменную значения ученика, которому принадлежит эта книга
        }

        let innerHTML = '';
        let _arr = (isBook) ? userBooks: user; // Инициализиуем переменную для создания массива под определенную страницу

        if (user) {
            _arr['fullname']  = `${user['surname']} ${user['firstname']} ${user['lastname']}`;
            _arr['fullclass'] = `${user['class']}${user['letter']}`;
        }

        if (GET['choose'] != 'edit') { // Личный кабинет
            setTitle('Личный кабинет');

            let arr = (isBook) ? {'ID': 'inventoryno', 'Название': 'name', 'Автор': 'author', 'Жанр': 'genre', 'Описание': 'comment'} : // Книга
                                {'ФИО': 'fullname', 'Класс': 'fullclass'}; // Ученик

            for (let item in arr) { // Конструируем блоки
                innerHTML += `<tr>
                                <td class="td_head">${item}: </td>
                                <td class="td_value">${_arr[arr[item]]}</td>
                            </tr>`;
            }
            document.querySelector('.head_information').innerHTML = innerHTML;
            document.querySelector('#edit').href = `acc.html?type=${GET['type']}&id=${GET['id']}&choose=edit`; //////////////////////////////////

            let information = document.querySelector('.information'); // Инициализируем блок с информацией, чтоб потом туда все поставить
            let nav = document.getElementById('btn'); // Иниуиализируем переменную чтоб в дальнейшем изменить ссылки с кнопками

            let accBlock = document.createElement('table');

            if (isBook) { // Если страница книжная
                accBlock.className = 'books';

                if (user) {
                    accBlock.innerHTML = `<tr>
                                            <th class="td_head">Ученик</th>
                                            <th class="td_value">${_arr['fullname']} 
                                                <span class="class">${_arr['fullclass']}</span>
                                            </th>
                                        </tr>
                                        <tr>
                                            <td class="td_head">Дата выдачи: </td>
                                            <td class="td_value">${userBooks['dateofissue']}</td>
                                        </tr>`;

                    nav.innerHTML = `<a href="change.html?type=give&bk=${userBooks['id']}&us=${user['id']}" class="but" id="delate_book"></a>`
                } else {
                    accBlock.innerHTML = '<tr><th class="td_value">Свободна</th></tr>';
                    nav.innerHTML = `<a href="search.html?type=users&im=${GET['id']}" class="but" id="add_book"></a>`
                }
            } else { // Если ученик
                accBlock.innerHTML = '<tr>\
                                            <th class="td_head">Книга</th>\
                                            <th class="td_value">Дата выдачи</th>\
                                        </tr>';

                nav.innerHTML += `<a href="search.html?type=books&im=${GET['id']}" class="but" id="add_book"></a>`; // Создаем кнопку с ссылкой на взятие книг в поиске

                if (!userBooks.length) { // Если книг у ученика нет
                    accBlock.innerHTML += `<tr>
                                                <td class="td_head">Нет книг</td>
                                                <td class="td_value">-</td>
                                            </tr>`;
                } else if (userBooks.length == 1) { // Если есть, добавить кнопку с ссылкой на открепление своей книги
                    nav.innerHTML += `<a href="change.html?type=give&us=${GET['id']}&bk=${userBooks[0]['id']}" class="but" id="delate_book"></a>`;
                } else {
                    nav.innerHTML += `<a href="search.html?type=books&im=${GET['id']}&del=1" class="but" id="delate_book"></a>`;
                }

                for (let book of userBooks) { // Перебираем каждую книгу ученика и создаем под нее блок
                    accBlock.innerHTML += `<tr>
                                                <td class="td_head">${book['name']}</td>
                                                <td class="td_value">${book['dateofissue']}</td>
                                            </tr>`;
                }
            }
            information.append(accBlock); // Добавляем наш созданный блок в главный блок

        } else { // Страница редактирования
            let title = 'Редактировать ' + ( (isBook == 2) ? 'книгу' : (isBook == 1) ? 'группу' : 'профиль' );
            setTitle(title);

            document.body.innerHTML += `<div class="dark" id="w_save">
                                            <div class="alert_window">
                                                <div class="alert_message" id="result">Подождите...</div>
                                                <div class="sure">
                                                    <div class="but_window_space">
                                                        <a class="but_window" id="cancel">Ок</a>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                       <div class="dark" id="w_del">
                                            <div class="alert_window">
                                                <div class="alert_message">Вы уверены, что хотите удалить профиль?</div>
                                                <div class="sure">
                                                    <div class="but_window_space">
                                                        <a class="but_window" id="delete">Удалить</a>
                                                    </div>
                                                    <div class="but_window_space">
                                                        <div class="but_window" id="cancel">Отменить</div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>`; // Добавляем блок для вывода всплывающего окна удаления/редактирования ученика

            innerHTML = `<h1>${title}</h1><div class="but_nav"><div class="but" id="del" message="w_del"></div></div>`;

            let arr = (isBook) ? {'id': 'ID', 'name': 'Название', 'author': 'Автор', 'genre': 'Жанр', 'comment': 'Комментарий'}:
                                 {'surname' : 'Фамилия', 'firstname': 'Имя', 'lastname': 'Отчество', 'class': 'Класс', 'letter': 'Буква'};

            if (isBook == 1) {
                let result = {};
                for (let i in _arr) {
                    for (let j in _arr[i]) {
                        if (i == 0) {
                            result[j] = _arr[i][j];
                        } else {
                            if (result[j] != _arr[i][j]) {
                                result[j] = '';
                            }
                        }
                    }
                }
                _arr = result;
                delete arr['id'];
            }

            for (let item in arr) {
                innerHTML += '<div class="line">';
                if (item == 'comment') innerHTML += `<textarea type="text" name="comment" id="comment" class="good_input">${_arr[item]}</textarea>`;
                else                   innerHTML += `<input type="text" name="${item}" id="${item}" value="${_arr[item]}" class="necessary_input good_input">`;
                innerHTML += `<label for="${item}">${arr[item]}</label></div>`;
            }

            innerHTML += '<div><input type="button" id="submit" value="Сохранить" class="good_input" message="w_save"></div';

            let box = document.querySelector('.box');
            box.innerHTML = innerHTML;

            if (!isBook) { // Если ученик
                box.querySelector('#lastname').className = 'good_input'; // Отчетсво писать необязательно
                box.querySelector('#letter').maxLength = 1; // Длина Буквы класса не превышает одной

                let inputClass = box.querySelector('#class');
                inputClass.type = 'number'; // тип номера класса - число
                inputClass.min = 1; // Минимум - 0
                inputClass.max = 11; // Максимум - 11

                document.getElementById('submit').onclick = function () { // Создаем функцию, которая будет выполнятся при нажатии на кнопку `Сохранить`
                    let firstname = document.querySelector("input[name=firstname]"); // Имя 
                    let surname   = document.querySelector("input[name=surname]"); // Фамилия
                    let lastname  = document.querySelector("input[name=lastname]"); // Отчество (если есть)
                    let classNum  = document.querySelector("input[name=class]"); // Класс (Число)
                    let classLtr  = document.querySelector("input[name=letter]"); // Класс (Буква)

                    firstname.value = firstname.value.trim();
                    surname.value   = surname.value.trim();
                    lastname.value  = lastname.value.trim();

                    // Проверяем правильность введенных данных
                    let _firstname = valid('username', firstname.value);
                    let _surname   = valid('username', surname.value);
                    let _lastname  = valid('username', lastname.value) || lastname.value == '';
                    let _classNum  = valid('class', classNum.value);
                    let _classLtr  = valid('letter', classLtr.value);

                    if (!_firstname || !_surname || !_lastname || !_classNum || !_classLtr) { // Если хотя бы один параметр неверен, вернуть ошибку
                        error('Некоректный ввод');
                        return;
                    }

                    let params = users.SELECT(); // Сохраняем данные таблицы в переменную
                    let ID = users.getIndexFromID(user['id']); // Сохраняем индекс нужного столбца

                    let values = { // Создаем словарь, для изменения значений столбца
                        'firstname': firstname.value,
                        'surname': surname.value,
                        'lastname': lastname.value,
                        'class': classNum.value,
                        'letter': classLtr.value
                    }

                    users.UPDATE(ID, values); // Обновляем значения, того самого ученика
                    
                    success(`acc.html?type=${GET['type']}&id=${GET['id']}`, 'Ученик успешно изменен!');
                }
            } else { // Если книга
                box.querySelector('#genre').className = 'good_input';
                if (isBook == 2) {
                    box.querySelector('#id').type = 'number';
                }

                document.getElementById('submit').onclick = function () { // Создаем функцию, которая будет выполнятся при нажатии на кнопку `Созранить`
                    let name    = document.querySelector("input[name=name]"); // Название
                    let genre   = document.querySelector("input[name=genre]"); // Жанр
                    let author  = document.querySelector("input[name=author]"); // Автор
                    let bookID  = document.querySelector("input[name=id]"); // Инвентарный номер книги
                    let comment = document.querySelector("textarea[name=comment]"); // Комментарий к книге

                    name.value    = name.value.trim();
                    genre.value   = genre.value.trim();
                    author.value  = author.value.trim();
                    comment.value = comment.value.trim();

                    // Проверяем правильность введенных данных
                    let _name    = valid('name', name.value);
                    let _author  = valid('name', author.value);
                    let _genre   = valid('name', genre.value) || genre.value == '';
                    let _comment = valid('comment', comment.value) || comment.value == '';
                    let _bookID  = (isBook == 2) ? valid('num', bookID.value) : 1;

                    if (!_name || !_genre || !_author || !_bookID || !_comment) { // Если хотя бы один параметр неверен, вернуть ошибку
                        error('Некоректный ввод');
                        return;
                    }

                    if (isBook == 1) { // Если группа
                        let IDs = [];
                        let data = books.SELECT()['groupid']['users'];

                        let values = {
                            'name': name.value,
                            'author': author.value,
                            'genre': genre.value,
                            'comment': comment.value
                        }

                        for (let item in data) {
                            if (data[item] == _arr['groupid']) {
                                IDs.push(parseInt(item));
                            }
                        }

                        for (let item in values) { // Убираем те параметры, которые пусты
                            if (values[item] == '') {
                               delete values[item];
                            }
                        }

                        for (let ID of IDs) {
                            books.UPDATE(ID, values);
                        }

                        success(`search.html?type=books&group=${GET['id']}`, 'Группа успешно изменена!');
                        return;
                    }

                    if (bookID.value != userBooks['inventoryno'] && books.isSameID(bookID.value)) { // Если выбрана занятая книга, также вернуть ошибку
                        error(`Книга под номером '${bookID.value}' уже существует!`);
                        return;
                    }

                    let params = books.SELECT(); // Сохраняем данные таблицы в переменную
                    let ID = books.getIndexFromID(userBooks['id']); // Сохраняем индекс нужного столбца

                    let values = { // Создаем словарь, для изменения значений столбца
                        'name': name.value,
                        'author': author.value,
                        'genre': genre.value,
                        'comment': comment.value,
                        'inventoryno': bookID.value
                    }

                    books.UPDATE(ID, values); // Обновляем значения, того самого ученика

                    success(`acc.html?type=book&id=${GET['id']}`, 'Книга успешна изменена!');
                }
            }

            document.querySelector('#delete').onclick = function () {
                if (isBook) {
                    books.DELETE(userBooks['id']); // Удаляем книгу из таблицы с id равным введенному

                    window.location = 'index.html'; // Переадресовать на главную страницу (это надо будет исправить!!!)
                } else {
                    users.DELETE(user['id']); // Удаляем ученика из таблицы с id равным введенному

                    if (userBooks) {
                        let values = {
                            'userid': null,
                            'dateofissue': null
                        };

                        let ID;
                        for (let value of userBooks) {
                            ID = books.getIndexFromID(value.id);
                            books.UPDATE(ID, values);
                        }
                    }

                    window.location = 'index.html';
                }
            }
        }
    </script>
</body>

</html>