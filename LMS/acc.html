<!-- version 1.0 release -->

<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>Читательский билет</title>

    <link rel="stylesheet" type="text/css" href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN" crossorigin="anonymous">
    <link rel="stylesheet" type="text/css" href="sources/style/account.css">
    <link rel="stylesheet" type="text/css" href="sources/style/message.css">
    <link rel="stylesheet" type="text/css" href="sources/style/button.css">

    <script type="text/javascript" src="sources/js/nesql.js"></script>
    <script type="text/javascript" src="sources/js/add.js"></script>
    <script type="text/javascript" src="sources/js/message.js"></script>
</head>

<body>
    <a class="but" id="home" href="index.html"></a> <!-- Button home -->
    <a class="but" id="back" onclick="history.back()"></a> <!-- Button back -->

    <div class="box">
        <div class="head">
            <nav>
                <a class="but" id="edit"></a>
            </nav>
            <table class="head_information"></table>
        </div>
        <div class="information">
            <nav id="btn"></nav>
        </div>
    </div>

    <script>
        let GET = parseURL(); // Сюда сохраняем данные из ссылки на страницу
        let isBook = (GET['type'] == 'book');

        if (isBook) {
            document.querySelector('.head_information').innerHTML = `
                <tr>
                    <td class="td_head">ID: </td>
                    <td class="td_value"></td>
                </tr>
                <tr>
                    <td class="td_head">Название: </td>
                    <td class="td_value"></td>
                </tr>
                <tr>
                    <td class="td_head">Автор: </td>
                    <td class="td_value"></td>
                </tr>
                <tr>
                    <td class="td_head">Жанр: </td>
                    <td class="td_value"></td>
                </tr>
                <tr>
                    <td class="td_head">Описание: </td>
                    <td class="td_value"></td>
                </tr>`;
        } else {
            document.querySelector('.head_information').innerHTML = `
                <tr>
                    <td class="td_head">ФИО: </td>
                    <td class="td_value"></td>
                </tr>
                <tr>
                    <td class="td_head">Класс: </td>
                    <td class="td_value"></td>
                </tr>`;
        }

        let users = new Table('users'); // Создаем таблицу для работы с учениками
        let books = new Table('books'); // Создаем таблицу для работы с книгами

        let user, userBooks;

        if (!isBook) {
            userBooks = books.equal(books.translate(), 'userid', GET['id']); // Сохраняем в переменную значения книг, принадлежащих ученику
            user      = users.equal(users.translate(), 'id', GET['id'])[0]; // Сохраняем в переменную значения ученика по ID
        } else {
            userBooks = books.equal(books.translate(), 'id', GET['id'])[0]; // Сохраняем в переменную значения книги по ID
            user      = users.equal(users.translate(), 'id', userBooks['userid'])[0]; // Сохраняем в переменную значения ученика, которому принадлежит эта книга
        }

        let type = (isBook) ? 'book' : 'user';
        let title = (isBook) ? 'Редактировать книгу' : 'Редактировать профиль';

        if (GET['choose'] == 'edit') { // Страница редактирования

            document.body.innerHTML += `<div class="dark" id="w_save">
                                            <div class="alert_window">
                                                <div class="alert_message" id="result">Подождите...</div>
                                                <div class="sure">
                                                    <div class="but_window_space">
                                                        <a class="but_window" id="cancel">Ок</a>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                       <div class="dark" id="w_del">
                                            <div class="alert_window">
                                                <div class="alert_message">Вы уверены, что хотите удалить профиль?</div>
                                                <div class="sure">
                                                    <div class="but_window_space">
                                                        <a class="but_window" id="delete">Удалить</a>
                                                    </div>
                                                    <div class="but_window_space">
                                                        <div class="but_window" id="cancel">Отменить</div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>`; // Добавляем блок для вывода всплывающего окна удаления/редактирования ученика

            if (!isBook) {
                document.getElementsByClassName('box')[0].innerHTML = `
                                <h1>${title}</h1>
                                <nav>
                                    <div class="but" id="del" message="w_del"></div>
                                </nav>
                                <form action="" method="POST">
                                    <div class="line">
                                        <input type="text" name="surname" id="surname" value="${user['surname']}" class="necessary_input good_input">
                                        <label for="surname">Фамилия</label>
                                    </div>
                                    <div class="line">
                                        <input type="text" name="firstname" id="firstname" value="${user['firstname']}" class="necessary_input good_input">
                                        <label for="firstname">Имя</label>
                                    </div>
                                    <div class="line">
                                        <input type="text" name="lastname" id="lastname" value="${user['lastname']}" class="good_input">
                                        <label for="lastname">Отчество</label>
                                    </div>
                                    <div class="line">
                                        <input type="number" name="class" id="class" value="${user['class']}" class="necessary_input good_input" min="1" max="11">
                                        <label for="class">Класс</label>
                                    </div>
                                    <div class="line">
                                        <input type="text" name="letter" id="letter" value="${user['letter']}" class="necessary_input good_input" maxlength="1">
                                        <label for="letter">Буква</label>
                                    </div>
                                    <div>
                                        <input type="button" id="submit" value="Сохранить" class="good_input" message="w_save">
                                    </div>
                                </form>`; // Создаем ячейки в которые будем вводить данные для ректирования

                document.getElementById('submit').onclick = function () { // Создаем функцию, которая будет выполнятся при нажатии на кнопку `Созранить`
                    let firstname = document.querySelector("input[name=firstname]"); // Имя 
                    let surname   = document.querySelector("input[name=surname]"); // Фамилия
                    let lastname  = document.querySelector("input[name=lastname]"); // Отчество (если есть)
                    let classNum  = document.querySelector("input[name=class]"); // Класс (Число)
                    let classLtr  = document.querySelector("input[name=letter]"); // Класс (Буква)

                    firstname.value = firstname.value.trim();
                    surname.value   = surname.value.trim();
                    lastname.value  = lastname.value.trim();

                    // Проверяем правильность введенных данных
                    let _firstname = valid('username', firstname.value);
                    let _surname   = valid('username', surname.value);
                    let _lastname  = valid('username', lastname.value) || lastname.value == '';
                    let _classNum  = valid('class', classNum.value);
                    let _classLtr  = valid('letter', classLtr.value);

                    if (!_firstname || !_surname || !_lastname || !_classNum || !_classLtr) { // Если хотя бы один параметр неверен, вернуть ошибку
                        error('Некоректный ввод');
                        return;
                    }

                    let params = users.SELECT(); // Сохраняем данные таблицы в переменную
                    let ID = users.getIndexFromID(user['id']); // Сохраняем индекс нужного столбца

                    let values = { // Создаем словарь, для изменения значений столбца
                        'firstname': firstname.value,
                        'surname': surname.value,
                        'lastname': lastname.value,
                        'class': classNum.value,
                        'letter': classLtr.value
                    }

                    users.UPDATE(ID, values); // Обновляем значения, того самого ученика
                    
                    success(`acc.html?type=${type}&id=${GET['id']}`, 'Ученик успешно изменен!');
                }
            } else {
                document.getElementsByClassName('box')[0].innerHTML = `
                            <h1>Редактировать книгу</h1>
                            <nav>
                                <div class="but" id="del" message="w_del"></div>
                            </nav>
                            <form action="" method="POST">
                                <div class="line">
                                    <input type="number" name="id" id="id" value="${userBooks['inventoryno']}" class="necessary_input good_input" autocomplete="off">
                                    <label for="id">ID</label>
                                </div>
                                <div class="line">
                                    <input type="text" name="name" id="name" value="${userBooks['name']}" class="necessary_input good_input" autocomplete="off">
                                    <label for="name">Название</label>
                                </div>
                                <div class="line">
                                    <input type="text" name="author" id="author" value="${userBooks['author']}" class="necessary_input good_input" autocomplete="off">
                                    <label for="author">Автор</label>
                                </div>
                                <div class="line">
                                    <input type="text" name="genre" id="genre" value="${userBooks['genre']}" autocomplete="off" class="good_input">
                                    <label for="genre">Жанр</label>
                                </div>
                                <div class="line">
                                    <textarea type="text" name="comment" id="comment" autocomplete="off" class="good_input" style="height: 68px;">${userBooks['comment']}</textarea>
                                    <label for="comment">Комментарий</label>
                                </div>
                                <div>
                                    <input type="button" id="submit" value="Сохранить" class="good_input" message="w_save">
                                </div>
                            </form>`; // Создаем ячейки в которые будем вводить данные для ректирования

                document.getElementById('submit').onclick = function () { // Создаем функцию, которая будет выполнятся при нажатии на кнопку `Созранить`
                    let name    = document.querySelector("input[name=name]"); // Название
                    let genre   = document.querySelector("input[name=genre]"); // Жанр
                    let author  = document.querySelector("input[name=author]"); // Автор
                    let bookID  = document.querySelector("input[name=id]"); // Инвентарный номер книги
                    let comment = document.querySelector("textarea[name=comment]"); // Комментарий к книге

                    name.value    = name.value.trim();
                    genre.value   = genre.value.trim();
                    author.value  = author.value.trim();
                    comment.value = comment.value.trim();

                    // Проверяем правильность введенных данных
                    let _name    = valid('name', name.value);
                    let _author  = valid('name', author.value);
                    let _genre   = valid('name', genre.value) || genre.value == '';
                    let _comment = valid('name', comment.value) || comment.value == '';
                    let _bookID  = valid('num', bookID.value);

                    if (!_name || !_genre || !_author || !_bookID || !_comment) { // Если хотя бы один параметр неверен, вернуть ошибку
                        error('Некоректный ввод');
                        return;
                    }

                    if (bookID != userBooks['inventoryno'] && books.isSameID(bookID)) { // Если выбрана занятая книга, также вернуть ошибку
                        error(`Книга под номером '${bookID}' уже существует!`);
                        return;
                    }

                    let params = books.SELECT(); // Сохраняем данные таблицы в переменную
                    let ID = books.getIndexFromID(userBooks['id']); // Сохраняем индекс нужного столбца

                    let values = { // Создаем словарь, для изменения значений столбца
                        'name': name.value,
                        'author': author.value,
                        'genre': genre.value,
                        'comment': comment.value,
                        'inventoryno': bookID.value
                    }

                    
                    books.UPDATE(ID, values); // Обновляем значения, того самого ученика

                    success(`acc.html?type=book&id=${GET['id']}`, 'Книга успешна изменена!');
                }
            }

            document.querySelector('#delete').onclick = function () {
                if (isBook) {
                    books.DELETE(userBooks['id']); // Удаляем книгу из таблицы с id равным введенному

                    window.location = 'index.html'; // Переадресовать на главную страницу (это надо будет исправить!!!)
                } else {
                    users.DELETE(user['id']); // Удаляем ученика из таблицы с id равным введенному

                    if (userBooks) {
                        let values = {
                            'userid': null,
                            'dateofissue': null
                        };

                        let ID;
                        for (let value of userBooks) {
                            ID = books.getIndexFromID(value.id);
                            books.UPDATE(ID, values);
                        }
                    }

                    window.location = 'index.html'; // Переадресовать на главную страницу (это надо будет исправить!!!)
                }
            }

        } else { // Главная страница ученика
            let tableValues = document.getElementsByClassName('td_value'); // Создаем переменную для работы с

            if (isBook) {
                tableValues[0].innerHTML = userBooks['inventoryno']; // ID
                tableValues[1].innerHTML = userBooks['name']; // Название книги
                tableValues[2].innerHTML = userBooks['author']; // Автор
                tableValues[3].innerHTML = userBooks['genre']; // Жанр
                tableValues[4].innerHTML = userBooks['comment']; // Комментарий
            } else {
                tableValues[0].innerHTML = `${user['surname']} ${user['firstname']} ${user['lastname']}`; // Полное имя
                tableValues[1].innerHTML = `${user['class']}${user['letter']}`; // Класс, Буква
            }

            let a = document.getElementsByClassName('but'); // Сменяем текущую ссылку на ссылку для редактирования
            a[2].href = `acc.html?type=${type}&id=${GET['id']}&choose=edit`;

            let information = document.querySelector('.information'); // Инициализируем блок с информацией, чтоб потом туда все поставить
            let nav = document.getElementById('btn'); // Иниуиализируем переменную чтоб в дальнейшем изменить ссылки с кнопками

            if (isBook) {
                let userBlock = document.createElement('table');

                userBlock.className = 'books';

                if (user) {
                    userBlock.innerHTML = `<tr>
                                                <th class="td_head">Ученик</th>
                                                <th class="td_value">${user['surname']} ${user['firstname']} ${user['lastname']} 
                                                    <span class="class">${user['class']}${user['letter']}</span>
                                                </th>
                                            </tr>
                                            <tr>
                                                <td class="td_head">Дата выдачи: </td>
                                                <td class="td_value">${userBooks['dateofissue']}</td>
                                            </tr>`;

                    nav.innerHTML = `<a href="change.html?type=give&bk=${userBooks['id']}&us=${user['id']}" class="but" id="delate_book"></a>`
                } else {
                    userBlock.innerHTML = '<tr><th class="td_value">Свободна</th></tr>';
                    nav.innerHTML = `<a href="search.html?type=users&im=${GET['id']}" class="but" id="add_book"></a>`
                }

                information.append(userBlock); // Добавляем наш созданный блок в главный блок
            } else {
                let booksBlock = document.createElement('table'); // Создаем блок-таблицу где будем выводить все данные учащегося
                
                booksBlock.className = 'books'; // Назваем блок классом books
                booksBlock.innerHTML = '<tr>\
                                        <th class="td_head">Книга</th>\
                                        <th class="td_value">Дата выдачи</th>\
                                    </tr>';

                nav.innerHTML += `<a href="search.html?type=books&im=${GET['id']}" class="but" id="add_book"></a>`; // Создаем кнопку с ссылкой на взятие книг в поиске

                if (!userBooks.length) { // Если книг у ученика нет
                    booksBlock.innerHTML += `<tr>
                                                <td class="td_head">Нет книг</td>
                                                <td class="td_value">-</td>
                                            </tr>`;
                } else if (userBooks.length == 1) { // Если есть, добавить кнопку с ссылкой на открепление своей книги
                    nav.innerHTML += `<a href="change.html?type=give&us=${GET['id']}&bk=${userBooks[0]['id']}" class="but" id="delate_book"></a>`;
                } else {
                    nav.innerHTML += `<a href="search.html?type=books&im=${GET['id']}&del=1" class="but" id="delate_book"></a>`;
                }

                for (let book of userBooks) { // Перебираем каждую книгу ученика и создаем под нее блок
                    booksBlock.innerHTML += `<tr>
                                                <td class="td_head">${book['name']}</td>
                                                <td class="td_value">${book['dateofissue']}</td>
                                            </tr>`;
                }

                information.append(booksBlock); // Добавляем наш созданный блок в главный блок
            }
        }
    </script>
</body>

</html>