<!-- version 1.0 release -->

<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>Книга</title>
    <link rel="stylesheet" type="text/css" href="sources/style/button.css">
    <link rel="stylesheet" type="text/css" href="sources/style/query.css">
</head>

<body>
    <a class="but" id="home" href="index.html"></a>

    <div class="box">
        <div class="head">
            <form action="#" method="post">
                <table class="head_information">
                    <tr>
                        <td class="td_head">Книга: </td>
                        <td class="td_value">
                            <div class="little"></div>
                        </td>
                        <td class="td_edit">
                            <a href="get_book.html" class="but" id="edit"></a>
                        </td>
                    </tr>
                    <tr>
                        <td class="td_head">Ученик: </td>
                        <td class="td_value">
                            <div class="little"></div>
                    </tr>
                    <tr>
                        <td class="td_head">Дата: </td>
                        <td class="td_value"><input type='date' name="date" id="date"></td>
                    </tr>
                </table>
                <input type="button" id="submit" value="Сдать">
            </form>
        </div>
    </div>

    <script>
        class Table {
            constructor(name) {
                this.name = name + '.json';
            }

            equal(traspose, param, value) {
                let result = [];
                for (let item in traspose) {
                    if (value == traspose[item][param]) {
                        result.push(traspose[item]);
                    }
                }
                return result;
            }

            SELECT(value) {
                try {
                    return JSON.parse(fs.readFileSync(this.name, 'utf8'));
                } catch (err) {
                    console.log('ОШИБКА ЧТЕНИЯ ТАБЛИЦЫ', err);
                }
            }

            write(params) {
                try {
                    fs.writeFileSync(this.name, JSON.stringify(params));
                } catch (err) {
                    console.log('ОШИБКА ИЗМЕНЕНИЯ ТАБЛИЦЫ', err);
                }
            }

            translate(data=this.SELECT()) {
                let result = [];
                for (let i = 0; i < Object.keys(data['id']['users']).length; i++) {
                    result[i] = {};
                    for (let item in data) {
                        result[i][item] = data[item]['users'][i];
                    }
                }
                return result;
            }
        }
    </script>

    <script>
        var fs = require("fs");
        var GET = [];
        var users = new Table('users');
        var books = new Table('books');

        let udata = users.translate();
        let bdata = books.translate();

        for (item of window.location.search.replace('?','').split('&')) {
            let value = item.split('=');
            GET[decodeURIComponent(value[0])] = decodeURIComponent(value[1]);
        }

        user = users.equal(udata, 'id', GET['us'])[0];
        book = books.equal(bdata, 'id', GET['bk'])[0];

        if (!user || !book || !book['userid']) {
            console.log('КНИГИ ИЛИ УЧЕНИКА НЕ СУЩЕСТВУЕТ')
        }

        let info = document.getElementsByClassName('head_information')[0];
        info.innerHTML = `<tr>
                            <td class="td_head">Книга: </td>
                            <td class="td_value">${book['name']}
                                <div class="little">${book['author']}</div>
                            </td>
                            <td class="td_edit">
                                <a href="search_book.html?im=${GET['us']}&del=1" class="but" id="edit"></a>
                            </td>
                        </tr>
                        <tr>
                            <td class="td_head">Ученик: </td>
                            <td class="td_value">${user['surname']} ${user['firstname']} ${user['lastname']}
                                <div class="little">${user['class']} ${user['letter']}</div>
                            </td>
                        </tr>
                        <tr>
                            <td class="td_head">Дата: </td>
                            <td class="td_value"><input type='date' name="date" id="date"></td>
                        </tr>`;

        document.getElementById('date').valueAsDate = new Date();

        document.querySelector('#submit').onclick = function() {
            let params = books.SELECT();
            let data = params['id']['users'];
            let id;

            for (let item in data) {
                if (data[item] == GET['bk']) {
                    id = item;
                    break;
                }
            }
            params['userid']['users'][id] = null;
            params['dateofissue']['users'][id] = new Date(document.getElementById('date').value).toLocaleDateString();

            books.write(params);
            console.log('Успешно');

            window.location = `account.html?id=${GET['us']}`;
        }
    </script>
</body>

</html>